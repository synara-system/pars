# path: core/scanners/react_exploit.py

import aiohttp
import asyncio
from typing import Callable, List, Dict
from .base_scanner import BaseScanner

class ReactExploitScanner(BaseScanner):
    """
    CVE-2025-55182 (React2Shell) & CVE-2025-66478 (Next.js RCE) Tarayıcısı.
    
    React Server Components (RSC) "Flight" protokolündeki Insecure Deserialization
    zafiyetini tespit etmeye çalışır.
    
    Tespit Yöntemleri:
    1. Pasif: 'rsc-action-id', 'next-action' başlıkları veya 'text/x-component' içerik tipi.
    2. Aktif: Flight protokolüne özel hazırlanmış serileştirilmiş payload gönderimi.
    """

    def __init__(self, logger, results_callback, request_callback: Callable[[], None]):
        super().__init__(logger, results_callback, request_callback)
        
        # RSC/Next.js Varlığını Gösteren İşaretler
        self.rsc_indicators = [
            "text/x-component",
            "rsc-action-id",
            "next-action",
            "Next-Router-State-Tree",
            "next-url",
            "_next/static"
        ]
        
        # CVE-2025-55182 Payload Şablonu (Basitleştirilmiş Simülasyon)
        # Gerçek saldırıda buraya zararlı bir Flight object stream gelir.
        # Biz güvenli bir "ping" veya "sleep" komutu enjekte edilmiş gibi davranacağız.
        self.flight_payload = (
            '["$@1",["react.server.reference","'
            '{"id":"server-action-id","bound":[null,{"$@2":'
            '{"id":"cve-2025-55182-test","name":"polluted"}}]}]'
        )

    @property
    def name(self):
        return "React2Shell (RSC) Exploit Scanner"

    @property
    def category(self):
        return "RCE_SSRF" # RCE kategorisine dahil ediyoruz

    async def scan(self, url: str, session: aiohttp.ClientSession, completed_callback: Callable[[], None]):
        """
        Tarama Mantığı:
        1. Ana sayfayı kontrol et, RSC/Next.js izleri ara.
        2. Eğer RSC tespit edilirse, Flight protokolü üzerinden payload gönder.
        """
        self.log(f"[{self.category}] React Server Components (CVE-2025-55182) analizi başlatılıyor...", "INFO")
        
        try:
            # 1. KEŞİF: RSC İzlerini Ara
            is_rsc_detected = False
            target_endpoint = url
            
            # Ana sayfaya GET isteği
            response, latency = await self._throttled_request(session, "GET", url)
            
            if response:
                headers_str = str(response.headers).lower()
                content_type = response.headers.get("Content-Type", "").lower()
                
                # Başlıklarda RSC izi ara
                for indicator in self.rsc_indicators:
                    if indicator.lower() in headers_str or indicator.lower() in content_type:
                        is_rsc_detected = True
                        self.log(f"[{self.category}] React/Next.js RSC yapısı tespit edildi: {indicator}", "INFO")
                        break
                
                # İçerikte Next.js izi ara (script tagleri vb.)
                if not is_rsc_detected:
                    text = await response.text()
                    if "_next/static" in text or "__next_f" in text:
                        is_rsc_detected = True
                        self.log(f"[{self.category}] Sayfa kaynağında Next.js izleri bulundu.", "INFO")

            # 2. SALDIRI: Eğer RSC varsa veya şüpheleniliyorsa Payload Gönder
            # Next.js Server Actions genellikle POST isteği bekler
            if is_rsc_detected:
                # Özel başlıklar
                exploit_headers = {
                    "Content-Type": "text/plain;charset=UTF-8", # Flight protokolü genellikle bunu kullanır
                    "Next-Action": "true", # Next.js Server Action tetikleyici
                    "rsc-action-id": "unknown_action" # Fuzzing noktası
                }
                
                self.log(f"[{self.category}] Flight Protokolü Payload'u gönderiliyor...", "INFO")
                
                post_response, post_latency = await self._throttled_request(
                    session, 
                    "POST", 
                    url, 
                    data=self.flight_payload, 
                    headers=exploit_headers
                )
                
                if post_response:
                    # Başarı Analizi
                    # 500 Hatası + Belirli stack trace -> Zafiyet olabilir (Insecure Deserialization hatası)
                    # Gecikme (Time-based) -> RCE Başarılı
                    
                    resp_text = await post_response.text()
                    
                    if post_latency > 5.0: # 5 saniye üzeri gecikme şüpheli (Eğer payload sleep içeriyorsa)
                        msg = f"REACT2SHELL RCE ŞÜPHESİ (Time-Based): Sunucu {post_latency:.2f}s gecikti."
                        self.add_result(self.category, "CRITICAL", msg, 10.0) # CVSS 10.0
                        self.log(msg, "SUCCESS")
                        
                    elif "ReactServerComponentsError" in resp_text or "Minified React error" in resp_text:
                        # React hatası döndüyse, payload işlenmeye çalışıldı demektir
                        msg = f"RSC Payload İşlendi (React Hatası): Deserialization tetiklendi."
                        self.add_result(self.category, "HIGH", msg, 7.5)
                        self.log(msg, "WARNING")
                        
                    elif post_response.status == 200 and "text/x-component" in post_response.headers.get("Content-Type", ""):
                         # Sunucu Flight stream ile yanıt verdiyse protokolü konuşabiliyoruz
                         msg = "RSC Flight Protokolü Aktif: Uç nokta payload kabul ediyor."
                         self.add_result(self.category, "INFO", msg, 0.0)
            
            else:
                self.log(f"[{self.category}] React/Next.js altyapısı tespit edilemedi. Exploit atlandı.", "INFO")

        except Exception as e:
            self.log(f"[{self.category}] Hata: {str(e)}", "ERROR")
        
        completed_callback()